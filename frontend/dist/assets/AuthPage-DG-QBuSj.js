import{u as E,a as T,r,c as P,j as e,N,l as x,b,d as j,g as w,e as S}from"./index-DzCRDEg8.js";import{t as h}from"./firestore-CSdz_xXz.js";const R=["lrnz.sga@gmail.com"];function y(t){return t.trim().toLowerCase()}function G(t){const o=R.join(",");return new Set(o.split(",").map(y).filter(Boolean))}const z=G();function g(t){return t?z.has(y(t)):!1}const i="bw_login_intent";function L(){const{user:t,role:o}=E(),c=T(),[d,l]=r.useState(!1),[u,s]=r.useState(""),[f,A]=r.useState(!1);if(r.useEffect(()=>{P()},[]),r.useEffect(()=>{async function a(){if(!(!t||o||sessionStorage.getItem(i)!=="coach"||!g(t.email))){A(!0),s("Sto completando l'accesso PT/Admin...");try{await b({email:t.email??"",displayName:t.displayName??"",coachAccessRequestedAt:new Date().toISOString()});for(let n=0;n<10;n+=1){await j();const m=await w(t);if(m==="admin"||m==="trainer"){sessionStorage.removeItem(i),c("/app/coach",{replace:!0});return}await new Promise(C=>setTimeout(C,700))}s("Accesso PT/Admin non pronto, riprova tra pochi secondi.")}catch(n){s(h(n))}finally{A(!1)}}}a()},[t,o,c]),t&&o)return sessionStorage.removeItem(i),e.jsx(N,{to:o==="client"?"/app/client":"/app/coach",replace:!0});if(t&&!o)return sessionStorage.getItem(i)==="coach"&&g(t.email)?e.jsx("main",{className:"page page-center",children:e.jsxs("section",{className:"card auth-card",children:[e.jsx("p",{className:"eyebrow",children:"Beastly Workout"}),e.jsx("h1",{children:"Accesso PT/Admin"}),e.jsx("p",{className:"hero-sub",children:f?"Attendi un attimo...":"Sto verificando il tuo profilo."}),u?e.jsx("p",{className:"message",children:u}):null,e.jsx("button",{className:"btn btn-ghost",disabled:f,onClick:()=>void x(),type:"button",children:"Esci e cambia account"})]})}):e.jsx(N,{to:"/app/client",replace:!0});async function I(){l(!0),s("");try{if(sessionStorage.setItem(i,"client"),(await S()).redirected){s("Apertura accesso Google...");return}c("/app/client",{replace:!0})}catch(a){s(h(a))}finally{l(!1)}}async function v(){l(!0),s("");try{sessionStorage.setItem(i,"coach");const a=await S();if(a.redirected){s("Apertura accesso Google...");return}if(!a.user){s("Accesso non completato. Riprova.");return}if(!g(a.user.email)){await x(),s("Questo account non Ã¨ abilitato come PT/Admin. Usa accesso utente.");return}await b({email:a.user.email??"",displayName:a.user.displayName??"",coachAccessRequestedAt:new Date().toISOString()});for(let p=0;p<8;p+=1){await j();const n=await w(a.user);if(n==="admin"||n==="trainer"){sessionStorage.removeItem(i),c("/app/coach",{replace:!0});return}await new Promise(m=>setTimeout(m,700))}s("Attivazione PT/Admin in corso. Riprova tra qualche secondo.")}catch(a){s(h(a))}finally{l(!1)}}return e.jsx("main",{className:"page page-center",children:e.jsxs("section",{className:"card auth-card",children:[e.jsx("p",{className:"eyebrow",children:"Beastly Workout"}),e.jsx("h1",{children:"Accedi con Google"}),e.jsx("p",{className:"hero-sub",children:"Inizia subito: entra come utente e completa il tuo percorso iniziale."}),e.jsx("button",{className:"btn",disabled:d,onClick:()=>void I(),type:"button",children:d?"Connessione...":"Continua con Google"}),e.jsx("div",{className:"divider"}),e.jsx("h2",{children:"Sei PT/Admin?"}),e.jsx("p",{className:"hint",children:"Usa il tuo account autorizzato per entrare nell'area coach."}),e.jsx("button",{className:"btn btn-ghost",disabled:d,onClick:()=>void v(),type:"button",children:"Continua con Google (PT/Admin)"}),u?e.jsx("p",{className:"message",children:u}):null]})})}export{L as AuthPage};
